#!/usr/bin/env perl

use strict;
use warnings;
use autodie qw(open);

use AnyEvent;
use EV;
use Plack::Loader;
use Test::More;
use Test::Sahara ();

my $app = Test::Sahara->create_fresh_app;

my ( $port ) = @ARGV;

my $server = Plack::Loader->load('Twiggy',
    port => $port,
    host => '127.0.0.1',
);

my $num_errors = 0;
my $pipe;
open $pipe, '>&3';

$EV::DIED = sub {
    $num_errors++;
    note($@);
};

my $term = AnyEvent->signal(
    signal => 'TERM',
    cb     => sub {
        print $pipe $num_errors;
        exit 0;
    },
);

my $int = AnyEvent->signal(
    signal => 'INT',
    cb     => sub {
        print $pipe $num_errors;
        exit 0;
    },
);

$server->run($app);
